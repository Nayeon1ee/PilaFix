<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="MemberManageDAO">
	<resultMap type="member" id="memberResult">
	    <id property="csMemberCode" column="CS_MEMBER_CODE"/>
	    <result property="csEmailId" column="CS_EMAIL_ID"/>
	    <result property="csPassword" column="CS_PASSWORD" />
	    <result property="csName" column="CS_NAME" />
	    <result property="csPhoneNumber1" column="CS_PHONE_NUMBER1" />
	    <result property="csPhoneNumber2" column="CS_PHONE_NUMBER2" />
	    <result property="csPhoneNumber3" column="CS_PHONE_NUMBER3" />
	    <result property="csBirth" column="CS_BIRTH" />
	    <result property="csGenderMw" column="CS_GENDER_MW" />
	    <result property="csDeleteYn" column="CS_DELETE_YN" />
	    <result property="csAgreementYn1" column="CS_AGREEMENT_YN1" />
	    <result property="csAgreementYn2" column="CS_AGREEMENT_YN2" />
	    <result property="csAgreementYn3" column="CS_AGREEMENT_YN3" />
	    <result property="csRegistrationType" column="CS_REGISTRATION_TYPE" />
	    <result property="csRegistrationDate" column="CS_REGISTRATION_DATE" />
	    <result property="csRoleCode" column="CS_ROLE_CODE" />
	    <result property="connectedCenterCode1" column="CONNECTED_CENTER_CODE1" />
	    <result property="connectedCenterCode2" column="CONNECTED_CENTER_CODE2" />
	    <result property="connectedCenterCode3" column="CONNECTED_CENTER_CODE3" />
	    <result property="connectedCenterName1" column="CONNECTED_CENTER_NAME1" />
	    <result property="connectedCenterName2" column="CONNECTED_CENTER_NAME2" />
	    <result property="connectedCenterName3" column="CONNECTED_CENTER_NAME3" />
	    <result property="ticketCodePersonal1" column="TICKET_CODE_PERSONAL1" />
		<result property="ticketRemainingCountPersonal1" column="TICKET_REMAINING_COUNT_PERSONAL1" />
		<result property="ticketStartDatePersonal1" column="TICKET_START_DATE_PERSONAL1" />
		<result property="ticketExpiryDatePersonal1" column="TICKET_EXPIRY_DATE_PERSONAL1" />
		<result property="ticketExpiryYnPersonal1" column="TICKET_EXPIRY_YN_PERSONAL1" />
		<result property="ticketCodeGroup1" column="TICKET_CODE_GROUP1" />
		<result property="ticketRemainingCountGroup1" column="TICKET_REMAINING_COUNT_GROUP1" />
		<result property="ticketStartDateGroup1" column="TICKET_START_DATE_GROUP1" />
		<result property="ticketExpiryDateGroup1" column="TICKET_EXPIRY_DATE_GROUP1" />
		<result property="ticketExpiryYnGroup1" column="TICKET_EXPIRY_YN_GROUP1" />
	</resultMap>

	<resultMap type="com.dev.pilafix.admin.member_trainer_manage.PaymentHistoryVO" id="paymentResult">
		<id property="paId" column="PA_ID" />
		<result property="ticketCode" column="TICKET_CODE" />
		<result property="paAmount" column="PA_AMOUNT" />
		<result property="memberCode" column="MEMBER_CODE" />
		<result property="paMethod" column="PA_METHOD" />
		<result property="paDatetime" column="PA_DATETIME" />
		<result property="centerName" column="CENTER_NAME" />
	</resultMap>
	
	<resultMap type="connectRequest" id="connectRequestResult">
		<id property="crCode" column="cr_code" />
		<result property="memberCode" column="MEMBER_CODE" />
		<result property="memberName" column="MEMBER_NAME" />
		<result property="centerCode" column="CENTER_CODE" />
		<result property="memberPhone" column="MEMBER_PHONE" />
		<result property="crReqDate" column="CR_REQ_DATE" />
		<result property="crConnectionYn" column="CR_CONNECTION_YN" />
		<result property="crConnectionDate" column="CR_CONNECTION_DATE" />
	</resultMap>
	
	<resultMap type="com.dev.pilafix.admin.member_trainer_manage.CenterConnectHistoryVO" id="connectHistoryResult">
		<id property="chCode" column="CH_CODE" />
		<result property="memberCode" column="MEMBER_CODE" />
		<result property="centerCode" column="CENTER_CODE" />
		<result property="chDatetime" column="CH_DATETIME" />
		<result property="chCurrentConnectionYN" column="CH_CURRENT_CONNECTION_YN" />
		<result property="disconnection_date" column="DISCONNECTION_DATE" />
		<result property="centerName" column="CENTER_NAME" />
		<result property="centerAddress" column="CENTER_ADDRESS" />
	</resultMap>
	
	<!-- 회원 목록 조회 -->
	<select id="getMemberList" resultMap="memberResult">
		SELECT * FROM TBL_CST
		WHERE CS_ROLE_CODE = 'ME'
		AND (CONNECTED_CENTER_CODE1 = 111 OR CONNECTED_CENTER_CODE2 = 111 OR CONNECTED_CENTER_CODE3 = 111);
	</select>
	<select id="getMember" resultMap="memberResult" >
		SELECT *  FROM TBL_CST WHERE CS_MEMBER_CODE=#{csMemberCode}
	</select>

	<!-- 강사 목록 조회 -->
	<select id="getTrainerList" resultMap="memberResult">
		SELECT * FROM TBL_CST WHERE CS_ROLE_CODE = 'TR'
	</select>

	
	<!-- 회원 연동 요청 목록 조회  -->
	<select id="getCenterRequestForMe" resultMap="connectRequestResult" >
		<![CDATA[
		SELECT * FROM TBL_CENTER_REQUEST 
		WHERE CENTER_CODE='111' 
			AND CR_CONNECTION_YN=FALSE 
			AND MEMBER_CODE < 8000 
			AND CR_REJECT_DATE IS NULL;
		]]>
		<!-- select * from tbl_center_request where center_code=#{centerCode} and cr_connection_yn=false AND MEMBER_CODE &gt; 8000 AND CR_REJECT_DATE IS NULL  -->
	</select>
	<!-- 강사 연동 요청 목록 조회  -->
	<select id="getCenterRequestForTr" resultMap="connectRequestResult" >
		<![CDATA[
		SELECT * FROM TBL_CENTER_REQUEST 
		WHERE CENTER_CODE='111' 
			AND CR_CONNECTION_YN=FALSE 
			AND MEMBER_CODE > 8000
			AND CR_REJECT_DATE IS NULL;
		]]>
		<!-- select * from tbl_center_request where center_code=#{centerCode} and cr_connection_yn=false AND MEMBER_CODE &lt; 8000 AND CR_REJECT_DATE IS NULL-->
	</select>
	
	
	<!-- 연동처리 STEP01 - TBL_CENTER_REQUEST 연동여부, 일자 업데이트  -->
	<update id="updateConn"  >
		UPDATE TBL_CENTER_REQUEST 
		SET CR_CONNECTION_YN=TRUE, CR_CONNECTION_DATE=CURRENT_TIMESTAMP 
		WHERE CR_CODE=#{crCode}
	</update> 
	<!-- 연동처리 STEP02 - TBL_CENTER_CONN에 이력 등록  -->
	<insert id="insertConnHistory" parameterType="java.util.Map">
		INSERT INTO TBL_CENTER_CONN 
		VALUES(#{crCode}, #{memberCode}, #{centerCode}, CURRENT_TIMESTAMP, TRUE);
	</insert>
	<!-- 연동처리 STEP03 - TBL_CST CONNECTED_CENTER_CODE 업데이트  -->
	<update id="updateCSTConn" parameterType="java.util.Map">
	    UPDATE TBL_CST SET
	        CONNECTED_CENTER_CODE1 = CASE WHEN CONNECTED_CENTER_CODE1 = 0 THEN #{centerCode} ELSE CONNECTED_CENTER_CODE1 END,
	        CONNECTED_CENTER_CODE2 = CASE WHEN CONNECTED_CENTER_CODE2 = 0 THEN CONNECTED_CENTER_CODE2 ELSE 0 END,
	        CONNECTED_CENTER_CODE3 = CASE WHEN CONNECTED_CENTER_CODE3 = 0 THEN CONNECTED_CENTER_CODE3 ELSE 0 END
	    WHERE CS_MEMBER_CODE = #{memberCode};
	</update>
	
	<!-- 연동 거절 -->
	<update id="updateRejectDate">
		UPDATE TBL_CENTER_REQUEST 
		SET CR_REJECT_DATE=CURRENT_TIMESTAMP
		WHERE CR_CODE=#{crCode}
	</update>
	
	
	

	<select id="getPaymentList" resultMap="paymentResult">
		SELECT * FROM TBL_PAYMENT
		<!--  데이터 들어온 후 바꿔야 함 쿼리문 틀린 것 같으니 다시 확인해보기..!
		SELECT PA_ID, TICKET_CODE,
		(SELECT CT_NAME FROM TBL_CENTER WHERE CT_CODE=(SELECT CENTER_CODE FROM TBL_TICKET WHERE TICKET_CODE=TICKET_CODE)) AS CENTER_NAME, 
		PA_AMOUNT, MEMBER_CODE, PA_METHOD, PA_DATETIME 
		FROM TBL_PAYMENT
		WHERE MEMBER_CODE=#{csMemberCode}
		;-->
	</select>
	
	<!--  
	<select id="getCenterConnectHistory" resultMap="connectHistoryResult">
		SELECT CH_CODE, CENTER_CODE,(SELECT CT_NAME FROM TBL_CENTER WHERE CT_CODE=CENTER_CODE)as CENTER_NAME FROM TBL_CENTER_CONN WHERE MEMBER_CODE=#{csMemberCode}
	</select>
	-->
	<select id="getCenterConnectHistory" resultMap="connectHistoryResult">
		SELECT CH_CODE, CENTER_CODE,(SELECT CT_NAME FROM TBL_CENTER WHERE CT_CODE=CENTER_CODE)as CENTER_NAME, 
		(SELECT CT_ADDRESS1 || ' ' || CT_ADDRESS2 || ' ' || CT_ADDRESS3 FROM TBL_CENTER WHERE CT_CODE=CENTER_CODE)as CENTER_ADDRESS
		FROM TBL_CENTER_CONN WHERE MEMBER_CODE=#{csMemberCode}
	</select>
	
</mapper>